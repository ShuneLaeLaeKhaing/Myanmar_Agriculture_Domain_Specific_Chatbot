import logging
from typing import Optional, Dict
from .hybrid_retriever import HybridRetriever
from .web_search import WebSearcher
from .price_checker import PriceChecker
from .feedback_logger import FeedbackLogger
import time
import re
from pyidaungsu import tokenize
from typing import List
from rapidfuzz import process, fuzz
import streamlit as st


logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class ResponseGenerator:
    def __init__(self):
        """Initialize with fallback handling"""
        try:
            @st.cache_resource
            def get_retriever():
                return HybridRetriever("faq.json", "faiss_index")
            self.retriever = get_retriever()
            self.web = WebSearcher()
            self.price_checker = PriceChecker()
            self.min_faq_score = 0.3
            self.feedback_logger = FeedbackLogger()
            logger.info("Response generator ready")
        except Exception as e:
            logger.error(f"Initialization failed: {str(e)}")
            raise
        self.agri_keywords = [
            # Crops and plants
            "စပါး", "စပါးစိုက်ပျိုး", "သီးနှံ", "ငှက်သီး", "မြေပဲ", "ခဲပြားပဲ", "လာဘီ", "မတ်လွန်း", "ငှက်ပျော", "စပျစ်", "သရက်", "သစ်တော်ပင်", "သင်္ဘောသီး", "ဒူးရင်း", "ခရမ်းချဉ်သီး", "ခရမ်းသီး", "နနွင်း", "မုန်လာဥနီ", "မုန်လာဥဖြူ", "မုန်ညင်း", "ငရုပ်ပွ", "ကြက်သွန်ဖြူ", "ကြက်သွန်နီ", "ရှမ်းထန်းသီး", "ထန်းလုံး", "သံပုယျသီး", "သံပယ်သီး", "သစ်တော်သီး", "ကြာ", "မိုးကြာ", "ကန်စွန်း", "မျှစ်", "အာလူး", "မုန်ညင်းရွက်", "နံနံရွက်", "သစ်ကြိုးသီး", "ထန်းသီး", "မက်မြူနာ", "လိမ္မော်", "သင်္ဘော", "မူဆယ်သီး", "ပန်းသီး", "ဖရဲသီး", "နွားပျစ်", "နွားသီး", "ကုလားပဲ", "ဆားပဲ", "ကြာဇံပင်", "နွားအုန်း", "မက်မွန်", "ဆီပဲ", "နံနံပင်", "ကြက်ညှင်း", "ခရမ်းချဉ်သီး", "ငှက်သီး", "ကြက်သွန်", "ဆလန်သီး", "ပဲပြား", "ဆီစေ့", "တာဝန်ပင်", "ဇလုံ", "ကန်စွန်းအရွက်", "စပျစ်သီး", "ကုလားပဲ", "ကြက်မောက်", "ဆီစေ့", "ဆားပဲ", "သစ်သီးသီး", "ချင်း", "ငနက်သီး", "သာယာသီး", "သံပုယျသီး", "ငပိသီး", "ထန်းလုံး", "ကွမ်းသီး", "မင်းသလားသီး", "နွားသီး", "မုန်တိုင်း", "မုန်ညင်း", "မုန်ညင်းရွက်", "ပဲပင်", "သာသနာပင်", "မော်လမြိုင်သီး", "ဆေးဝါးပင်", "ဆေးသီး", "ခေါက်ဆွဲပင်", "မိုးညှင်းပင်", "စပါးသီး", "မုန်လာဥနီသီး", "ကြက်သွန်နီရွက်", "ပဲစေ့", "ထန်းသီးသီး", "သရက်သီး", "နွားတစ်ကောင်", "ချင်းသီး",

            # Pest,Disease and Fertilizer
            "ပိုးမွှား", "ပိုးသတ်ဆေး", "ပိုးသတ်ပစ္စည်း", "ပိုးဖျက်ဆေး", "ပိုးကင်းမြစ်", "ပိုးချောင်း", "ပိုးသတ်ဆေးဖျန်း", "သားရိုးပိုး", "တောင်ပိုး", "ဖုတ်တောင်", "ငင်သေးငယ်ပိုး", "မျှစ်စည်းပိုး", "သေးငယ်ပိုး", "အစေးထူပိုး", "သွေးစုပ်ပိုး", "သင်္ကြန်ပိုး", "အပင်ကျူးကျော်ပိုး", "ငှက်စောင်ပိုး", "နို့ယိုပိုး", "ပိုးတော", "နဂါးပိုး", "ပိုးမွှားကြီး", "ငရုပ်ပွပိုး", "ကြက်သွန်ပိုး", "ပိုးခြံခြံ", "အစေးပိုး", "ပိုးအကြီး", "ငှက်ပျောပိုး", "ဆင်မြဲပိုး", "တောက်ပိုး", "ဝါလွန်ပိုး", "ငှက်ပျောရည်ပိုး", "အစက်ပြားပိုး", "တက်လှည့်ပိုး", "အနုမြစ်ပိုး", "ကြွက်", "ငှက်ဖမ်းကင်း", "တိရစ္ဆာန်ကင်း", "ဖျန်းဆေး", "ဓာတု肥料", "အသီးသီး肥料", "ကျောက်စွဲ肥料", "ဓာတုရော肥料", "သဘာဝ肥料", "ပွင့်ပေါက်肥料", "ဓာတုသဘာဝပေါင်း肥料", "သစ်ရွက်肥料", "ဓာတုဖျန်းဆေး", "မျှင်ဆေး", "အခြောက်ဖျန်းဆေး", "ထွက်သွားဆေး", "အစေ့နက်ဖျန်းဆေး", "ပိုးဖျက်ဖျန်းဆေး", "မိုးရွာမတိုင်းဖျန်းဆေး", "မက်မြူနာပိုး", "ခရမ်းချဥ်ပိုး", "စပါးငှက်ပျောပိုး", "ငှက်ဖမ်းတိုင်", "မီးဖွားကင်း", "ကြောင်မဖမ်းကင်း", "ဓာတုထည်ပစ္စည်း", "ပိုးသတ်ဆေးအထုပ်", "မီးဖွားပိုး", "ပိုးကင်းကင်း", "ပိုးကင်းအကြံ", "ဆီးကျွေးပိုး", "နို့ဖျန်းပိုး", "ရေစုပ်ပိုး", "ငှက်ဖမ်းပိုး", "ချွဲလွှဲပိုး", "တောင်စွန်းပိုး", "ဆွဲသုတ်ပိုး", "ပျက်ယွင်းပိုး", "အပင်ထိခိုက်ပိုး", "နို့ယိုသွားပိုး", "အစိမ်းကျောက်肥料", "ဆားဆေးတံ", "ပိုးဖျက်တံ", "ဓာတုဖျန်းဘူး",

            # Equipment and Tools
            "ထွန်စက်", "လှည်း", "ရထားစက်", "ရေနံစက်", "ရေနံလှည်း", "မော်တာစက်", "စပါးထုတ်စက်", "စပါးသုတ်စက်", "မျှစ်ဖြတ်စက်", "ရေပန်းစက်", "စပါးခုပ်စက်", "ကောက်စက်", "ပဲစက်", "ရေမြောင်း", "မြေစုပ်စက်", "ရေငှက်စက်", "မော်တာရေဆင်", "ရေမြောင်းအဖွဲ့", "ရေသွန်းစက်", "ရေဖျန်းစက်", "တောင်ဖောက်စက်", "စပါးခူးစက်", "အရွက်ဖြတ်စက်", "ကွင်းချောင်း", "ငှက်ဖမ်းကြိုး", "သဲတင်စက်", "မြေဆွဲစက်", "ဓာတုစိမ်းကင်း", "သစ်တောလှည်း", "ကော်ဖီဖုတ်စက်", "အပင်စိုက်စက်", "ချည်စက်", "မီးဖုတ်စက်", "ဆားစက်", "ရေနံပေါင်းစက်", "အပင်အုပ်စက်", "ဂျင်စက်", "တောင်တန်းစက်", "ပင်ချုပ်စက်", "ထုံးတုံးစက်", "သီးသန့်စက်", "လှည်းတန်း", "မြေဆွဲတုံး", "ထွက်ကြွားစက်", "ကလေးထွန်စက်", "ရေငှက်စက်", "ခြံစည်းရိုး", "တံတိုင်း", "စပါးဖာ", "စပါးလှည်း", "ဓာတုဗူး", "ဖျန်းတံ", "ဖျန်းဘူး", "သစ်ရွက်ကောက်စက်", "ထွန်လှည်း", "မြေကောင်းစက်", "တောင်ဖြတ်စက်", "မြေပန်းစက်", "သစ်တောဖောက်စက်", "ရေစုပ်စက်", "ရေမောင်းစက်", "ရေမောင်းမြောင်း", "ရေကူးစက်", "တောင်စပ်စက်", "သစ်တောလှည်း", "မုန့်စက်", "စပါးမီးဖွားစက်", "စပါးသန့်စက်", "မြေတူးစက်", "စပါးတိုက်စက်", "ရေပျော်စက်", "စျေးတင်လှည်း", "ရေကန်ဖောက်စက်",

            # Weather and Soil Conditions
            "မြေညစ်", "မြေဆီလွှာ", "မြေညှင်း", "မြေသဲ", "မြေဖျား", "မြေရေစိမ်", "မြေလွန်", "မိုးရွာ", "မိုးတိမ်", "မိုးလေဝသ", "မိုးကြိုး", "မိုးတိမ်ထူ", "မိုးလျှံ", "မိုးချောင်း", "မိုးအနည်း", "မိုးအများ", "မိုးစက်", "မိုးမရှိ", "မိုးရေသိမ်း", "မိုးလေခံ", "မိုးကြီး", "မိုးကောင်းကင်", "မိုးညှင်း", "မိုးပျံ့", "မိုးဖျော့", "မိုးခေါင်", "မိုးအေး", "မိုးစွဲ", "မိုးညှင်းမြေ", "ရေငွေ့ပြင်း", "ရေကြီး", "ရေလျှံ", "မြေစိုမြေသား", "မြေကောင်းမြေညံ့", "မြေရေကန်", "ရေကြီးရေချောင်း", "မြေကြီးမြေငယ်", "မြေဆီမြေသဲ", "သဘာဝအခြေအနေ", "မြေမြှုပ်", "မြေတုပ်", "မြေအောက်ရေ", "မြေစိုစွတ်", "မြေရေပမာဏ", "မိုးနည်းကာလ", "မိုးအပူချိန်", "မိုးလေ", "တောင်ပျံ့မိုး", "တောင်မြေသဲ", "မိုးဖွားကောင်း", "မြေဆီဓာတ်", "မြေတူးလှည့်", "မိုးလေသတင်း", "ရေဖိအား", "မြေတွင်းအပူ", "တောင်ခြေမြေ", "မိုးလေကောင်း", "ရေမြေချို့တဲ့မှု", "ရေဓာတ်ပြောင်းလဲမှု",

            # other
            "စိုက်ပျိုး","ရိတ်သိမ်းမှု", "စိုက်ပျိုးတန်ဖိုးမြှင့်မှု", "စိုက်ပျိုးလုပ်ငန်းရှင်", "စိုက်ပျိုးရေးကိစ္စရပ်များ", "စိုက်ပျိုးလုပ်ငန်းများ", "စိုက်ပျိုးအခြေအနေ", "ရွေးချယ်စိုက်ပျိုးမှု", "အစဉ်အလာစိုက်ပျိုး", "အတည်ပြုစိုက်ပျိုးနည်း", "စိုက်ပျိုးသုံးစွဲမှု", "စိုက်ပျိုးအုပ်စု", "စိုက်ပျိုးပုံစံ", "စိုက်ပျိုးလမ်းညွှန်", "စိုက်ပျိုးရေးဥပဒေ", "ရုပ်ပိုင်းဆိုင်ရာစိုက်ပျိုးနည်း", "အာဟာရညှိမှု", "စိုက်ပျိုးသိပ္ပံနည်းကျ", "သီးနှံညှိနှိုင်းမှု", "ထွက်ရှိမှုတိုးမြှင့်မှု", "ရိတ်သိမ်းသတ်မှတ်ချိန်", "တောင်သူကြီး", "တောင်သူငယ်", "တောင်သူဧည့်ခံ", "တောင်သူလုပ်သား", "တောင်သူအဖွဲ့", "တောင်သူသမား", "အများပြည်သူလုပ်သား", "တောင်သူအဖွဲ့အစည်း", "စုစည်းရေးလုပ်ငန်း", "စိုက်ပျိုးထောက်ပံ့မှု", "စိုက်ပျိုးအကူအညီ", "စိုက်ပျိုးစီမံကိန်း", "သီးနှံသဘာဝ", "သီးနှံကောင်းကောင်း", "သီးနှံပျက်စီးမှု", "သီးနှံမတော်", "သီးနှံဖောက်သည်လှည့်မှု", "ထွက်နိုင်မှု", "သီးနှံသိပ္ပံ", "သီးနှံအမျိုးအစားရွေးချယ်မှု", "သီးနှံတောင်ယာ", "သီးနှံဖွံ့ဖြိုးရေး", "စိုက်ပျိုးလုပ်ငန်းခွင်", "စိုက်ပျိုးစနစ်ပြောင်းလဲမှု", "စိုက်ပျိုးကုန်ကျစရိတ်", "စိုက်ပျိုးအလျော့အတင်း", "ရိတ်သိမ်းလုပ်ငန်းခွင်", "စိုက်ပျိုးမြေလွှဲပြောင်းမှု", "စိုက်ပျိုးအာမခံမှု", "စိုက်ပျိုးလက်မှတ်", "စိုက်ပျိုးသတ္တု", "စိုက်ပျိုးမြေမတော်မှု", "စိုက်ပျိုးဦးစားပေး", "စိုက်ပျိုးရည်ရွယ်ချက်", "လယ်ယာစီမံခန့်ခွဲမှု", "စိုက်ပျိုးအနာဂတ်အစီအစဉ်", "တောင်သူလယ်သမားတစ်ဦး", "တောင်သူကြီးဌာန", "စိုက်ပျိုးမြေစာရင်း", "စိုက်ပျိုးအစီအစဉ်", "စိုက်ပျိုးနယ်မြေ", "စိုက်ပျိုးအရင်းအမြစ်", "ဈေးကွက်ဖွံ့ဖြိုးရေး", "ဈေးကွက်သတင်းအချက်အလက်", "ဈေးကွက်သဘောတူစာချုပ်", "ဈေးကွက်တန်ဖိုးကောင်းမှု", "ဈေးကွက်ဝင်ခွင့်", "ဈေးကွက်ဖွင့်လှစ်မှု", "အခြေခံဈေးနှုန်း", "စျေးဖွင့်နည်းလမ်း", "စျေးကွက်ထောက်ပံ့မှု", "ဈေးကွက်စီမံကိန်း", "စျေးကွက်စစ်တမ်း", "စျေးကွက်ရောင်းအား", "ဈေးကွက်ဦးတည်ချက်", "စျေးကွက်တုံ့ပြန်မှု", "အထုပ်ဖွင့်မှု", "အရည်အသွေးထိန်းသိမ်းမှု", "စျေးကွက်ကြီးကြပ်မှု", "ဈေးကွက်ရှာဖွေမှု", "ကုန်ကြမ်းစီမံခန့်ခွဲမှု", "ကုန်စည်သယ်ယူပို့ဆောင်ရေး", "သယ်ယူပို့ဆောင်မှုလမ်းကြောင်း", "စိုက်ပျိုးလှုပ်ရှားမှု", "ကုန်ကြမ်းအသုံးချမှု", "ထုတ်ကုန်စစ်ဆေးမှု", "ထုတ်ကုန်စီမံခန့်ခွဲမှု", "ထုတ်ကုန်စနစ်", "ထုတ်ကုန်အမည်", "ထုတ်ကုန်နယ်မြေ", "ထုတ်ကုန်စျေးနှုန်း", "ထုတ်ကုန်တင်သွင်းမှု", "ထုတ်ကုန်ထုတ်လုပ်မှုလုပ်ငန်း", "ထုတ်ကုန်သက်တမ်း", "ထုတ်ကုန်ဖျက်သိမ်းမှု", "ထုတ်ကုန်အသစ်ဖြစ်မှု", "ထုတ်ကုန်ဖေါ်ပြမှု", "စိုက်ပျိုးထုတ်ကုန်လက်မှတ်", "စိုက်ပျိုးထုတ်ကုန်တန်ဖိုး", "စိုက်ပျိုးစစ်ဆေးမှု", "စိုက်ပျိုးကုန်ကျစရိတ်သတင်း", "ထုတ်ကုန်သက်တမ်းမရှိမှု", "စျေးကွက်ပျက်ကွက်မှု", "စျေးကွက်စွမ်းဆောင်ရည်", "စျေးကွက်အောင်မြင်မှု", "စျေးကွက်ခိုင်မာမှု", "ဈေးကွက်ရင်းနှီးမြှုပ်နှံမှု", "စျေးကွက်ဈေးကွက်သတင်း", "စျေးကွက်တန်ဖိုးပြောင်းလဲမှု", "တင်သွင်းအခွန်", "ထုတ်ကုန်ခွဲခြားမှု", "ပစ္စည်းပြန်အမ်းမှု", "ထုတ်ကုန်အညွှန်း", "ဈေးကွက်စုံစမ်းရေး", "ဈေးကွက်ရှာဖွေမှုလေ့လာရေး", "စိုက်ပျိုးစနစ်သစ်", "စိုက်ပျိုးအင်တာနက်အသုံးပြုမှု", "စိုက်ပျိုးဉာဏ်ရည်ကွန်ယက်", "စိုက်ပျိုးသိပ္ပံနှင့်နည်းပညာ", "တောင်သူဘဏ်", "လယ်ယာအာမခံမှုစနစ်", "လယ်ယာခွန်", "စိုက်ပျိုးသက်တမ်းတိုးချဲ့မှု", "ပတ်ဝန်းကျင်ထိခိုက်မှု", "တောင်သူအသက်မွေးဝမ်းကြောင်းတည်မြဲမှု", "ငွေကြေးထောက်ပံ့မှု", "ငွေချေးစနစ်", "အချေးငွေ", "ထုတ်လုပ်မှုတိုးမြှင့်မှု", "မြေအပေါ်ဆောင်ရွက်မှု", "အပင်နှင့်အမူအရာသိပ္ပံ", "ရေနံစိုက်ပျိုးမှု", "နည်းပညာသုံးစွဲမှု", "လယ်ယာနည်းပညာပြပွဲ", "ထုတ်ကုန်ကုန်ကြမ်းလမ်းညွှန်", "စိုက်ပျိုးအချိန်ဇယား", "အစောပိုင်းစိုက်ပျိုးမှု", "နောက်ကျစိုက်ပျိုးမှု", "ပတ်ဝန်းကျင်လုံခြုံရေး", "ရေဆာလန်စနစ်", "ပတ်ဝန်းကျင်ထိန်းသိမ်းရေး", "ပတ်ဝန်းကျင်ပြဿနာ", "ရေညစ်မှု", "မြေညစ်မှု", "သဘာဝဖျက်စီးမှု", "ရေရှားခြင်း", "မိုးခေါင်ခြင်း", "ဓာတုဖောက်ထွက်မှု", "ရေသန့်တင်ဆောင်မှု", "ရေဆေးမှုစနစ်", "ရေထိန်းချုပ်မှုစနစ်", "မြေဖောက်လုပ်ငန်း", "မြေထွင်လုပ်ငန်း", "မြေအုပ်စနစ်", "မြေလွှဲပြောင်းခြင်း"

        ]

    def _is_agriculture_related(self, text: str) -> bool:
        text_lower = text.lower()
        
        # Unigram match
        if any(keyword in text_lower for keyword in self.agri_keywords):
            return True

        # Bigram token match
        tokens = tokenize(text, form='word')
        for i in range(len(tokens) - 1):
            bigram = tokens[i] + tokens[i + 1]
            if bigram in self.agri_keywords:
                return True

        return False


    def generate_response(self, query: str) -> Dict[str, Optional[str]]:
        """Strict FAQ → Web fallback pipeline"""
        try:

            if not query or len(query.strip()) < 5:
                return self._empty_response()
            
            if not self._is_myanmar(query):
                return {
                    "source": "Language Error",
                    "response": "ကျေးဇူးပြု၍ မြန်မာလို မေးမြန်းပါ။ (Please ask in Myanmar language)",
                    "confidence": "low"
                }
            
            # Price Checker starts here
            logger.info(f"Original query: {query}")
        
            # More flexible normalization
            normalized_query = query.replace(" ", "").replace("။", "").replace("၊", "")
            logger.info(f"Normalized query: {normalized_query}")

            found_products = self._find_products_in_query(normalized_query)
            
            # Check for price keywords (more flexible matching)
            price_keywords = ["ဈေး", "ဈေးနှုန်း"]
            price_keyword_found = any(
                kw in normalized_query 
                for kw in price_keywords
            )
            logger.info(f"Price keyword found: {price_keyword_found}")
            
            
            if price_keyword_found and found_products:
                logger.info("Attempting price check...")
                price_start = time.perf_counter()
                price_response = self.price_checker.get_price_response(normalized_query)
                logger.info(f"Price response: {price_response}")
                print(f"Price check took {time.perf_counter() - price_start:.2f} seconds")
                
                if price_response:
                    return {
                        "source": "💰 Market Price",
                        "response": price_response,
                    }
                
            
            # Phase 1: FAQ 
            faq_start = time.perf_counter()
            faq_answer = self.retriever.search(
                query, 
                # min_score=self.min_faq_score
            )
            print(faq_answer)
            if faq_answer:
                return {
                    "source": "📚 FAQ",
                    "response": faq_answer,
                    "confidence": "high"
                }
            
            print(f"FAQ search took {time.perf_counter() - faq_start:.2f} seconds")

            if not self._is_agriculture_related(query):
                self.feedback_logger.log_fallback(
                    query=query,
                    fallback_type="non_agricultural",
                    additional_context={"validation_method": "keyword_check"}
                )
                return {
                    "source": "Out of scope",
                    "response": "ကျေးဇူးပြု၍ စိုက်ပျိုးရေးနှင့် သက်ဆိုင်သော မေးခွန်းများကိုသာ မေးမြန်းပါ။",
                    "confidence": "low"
                }
            
            web_start = time.perf_counter()
            web_content = self.web.search(query)
            if  web_content:
                self.feedback_logger.log_fallback(
                    query=query,
                    fallback_type="web_results",
                    additional_context={"search_time": f"{time.perf_counter() - web_start:.2f}s"}
                )
                return {
                    "source": "🌐 Web",
                    "response": web_content,
                    "confidence": "medium"
                }
            print(f"Web search took {time.perf_counter() - web_start:.2f} seconds")
            
            return {
                "source": "Out of scope",
                "response": "///ကျေးဇူးပြု၍ စိုက်ပျိုးရေးနှင့် သက်ဆိုင်သော မေးခွန်းများကိုသာ မေးမြန်းပါ။",
                "confidence": "low"
            }
            
            
        except Exception as e:
            logger.error(f"Response generation failed: {e}")
            return self._error_response()

    

    def _empty_response(self) -> Dict:
        return {
            "source": None,
            "response": "ကျေးဇူးပြု၍ ပိုမိုရှင်းလင်းသော မေးခွန်းမေးပါ",
            "confidence": None
        }

    def _error_response(self) -> Dict:
        return {
            "source": "error",
            "response": "တောင်းပန်ပါသည်။ အဖြေရှာရန် မအောင်မြင်ပါ",
            "confidence": None
        }
    
    def _is_myanmar(self, text: str) -> bool:
        myanmar_unicode = re.compile(r'[\u1000-\u109F\uAA60-\uAA7F]')
        return bool(myanmar_unicode.search(text))
    
    def _find_products_in_query(self,query: str) -> List[str]:
        """Find all products mentioned in query using fuzzy matching"""
        # Check for products (partial matching)
        product_list = ["ကန်စွန်းရွက်","ကုလားပဲ", "ကုလားပဲ(HL)", "ကုလားပဲ(မြကြေး)", "ကြက်သွန်နီ", "ကြက်သွန်ဖြူ", "ကြက်သွန်ဖြူ(ထူးငါး)", "ကြက်သွန်ဖြူ(ထူးလေး)",
                    "ကြက်ဥ", "ခရမ်းချဉ်သီး", "ဂေါ်ဖီထုပ်", "ဂျင်း","ဂျုံ", "ဂျုံထွက်တိုး", "ဂျုံဖြူသန့်", "ငရုတ်ရှည်", "ငါးကြင်း", "ငါးကြင်းဖြူ(ဗိုက်ခွဲ)", "ငါးကွမ်းရှပ်",
                    "ငါးခုံးမ", "ငါးဒန်", "ငါးနှပ်", "ငါးပူတင်း", "ငါးပျက်", "ငါး‌‌‌ရွှေကြီး","ဆန်ကွဲ B(1,2)" ,"ဆန်ကွဲ B(2,3,4)","ဆားကြမ်း(ရိုးရိုး)ပင", "ဆားချော", "တီလားဗီးလား", "ထိုင်ဝမ်",
                    "ဒီဇယ်ဆီ (ပရီမီယံ)", "နေကြာဖတ်", "နှမ်းဆီ", "နှမ်းညို", "နှမ်းနီ", "နှမ်းဖတ်", "ပလာတူး", "ပလာလန်း", "ပါကူး", "ပေါ်ဆန်းမွှေး",
                    "ပဲကြီး", "ပဲစဉ်းငုံ", "ပဲစဉ်းငုံ(နီ)", "ပဲဆီ","ပဲတီစိမ်း", "ပဲတီစိမ်း(အသစ်)", "ပဲတီစိမ်းကြီး", "ပဲနီလုံးကြား", "ပဲဖတ်", "ပဲလွန်းဖြူ", "ဖွဲနု",
                    "ဘိုကိတ်", "ဘိုကိတ်ပဲ", "ဘဲဥ", "မတ်ပဲ", "မန်ကျီးသီးမှည့်", "မိုးကြက်သွန်နီ (အကြီး)", "မိုးကြက်သွန်နီ(အသေး)", "မြစ်သားကြက်သွန်နီ(အကြီး)", "မြစ်သားကြက်သွန်နီ(အသေး)", "မြေပဲ",
                    "မြေပဲတောင့်", "မြေပဲလုံးဆံနီ", "မြေပဲလုံးဆံဖြူ", "ရွှေငါး", "ဝါ", "သကြားဖြူ", "အာလူး", "အာလူး(မြန်မာသီး)",
                    "ဧည့်မထဆန်(မနောသုခ)သစ်", "ဧည့်မထဆန်(မနောသုခ)ဟောင်း",]
        normalized_query = query.replace(" ", "").replace("။", "").replace("၊", "")
        found_products = []
        
        # First check for exact matches
        for product in product_list:
            if product in normalized_query:
                found_products.append(product)
        
        # If no exact matches found, try fuzzy matching
        if not found_products:
            for product in product_list:
                result = process.extractOne(
                    product,
                    [normalized_query],
                    scorer=fuzz.token_set_ratio,
                    score_cutoff=60  # Lower threshold for partial matching
                )
                if result and result[1] >= 60:
                    found_products.append(product)
        
        return list(set(found_products))